version: '3.8'

services:
  # ==========================================
  # INFRAESTRUCTURA COMPARTIDA
  # ==========================================
  
  shared-redis:
    image: redis:7-alpine
    container_name: shared_redis
    ports:
      - "6379:6379"
    volumes:
      - shared_redis_data:/data
    networks:
      - agent_network

  shared_postgres:
    image: postgres:15-alpine
    container_name: shared_postgres
    environment:
      - POSTGRES_USER=shared_user
      - POSTGRES_PASSWORD=shared_pass
      - POSTGRES_DB=postgres
    ports:
      - "5432:5432"
    volumes:
      - shared_postgres_data:/var/lib/postgresql/data
      - ./init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql
    networks:
      - agent_network

  shared-minio:
    image: minio/minio
    container_name: shared-minio
    ports:
      - "9000:9000"   # Puerto API S3
      - "9001:9001"   # Consola Web (UI)
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - shared_minio_data:/data
    networks:
      - agent_network

  # ==========================================
  # INTECMAR API (NÃºcleo Unificado)
  # ==========================================

  intecmar_api:
    build: 
      context: ./Intecmar_api
    container_name: intecmar_api
    command: uvicorn backend.app.main:app --host 0.0.0.0 --port 8000 --reload --reload-exclude outputs/*
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - REDIS_URL=redis://shared-redis:6379/0
      - DATABASE_URL=postgresql+psycopg2://shared_user:shared_pass@shared_postgres:5432/mag_db
      - JWT_SECRET=${JWT_SECRET:-change-me}
      - MINIO_ENDPOINT=http://shared-minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_SECURE=False
      - MINIO_BUCKET_USERS=users
      # Agent specific envs
      - CELERY_BROKER_URL=redis://shared-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://shared-redis:6379/0
      - SHARED_DATA_PATH=/app/backend/shared_data
    volumes:
      - ./Intecmar_api:/app
    depends_on:
      - shared-redis
      - shared_postgres
    networks:
      - agent_network

  # ==========================================
  # INTECMAR WORKERS (Revista y Agente)
  # ==========================================

  magazine_worker:
    build: 
      context: ./Intecmar_api
    container_name: magazine_worker
    command: celery -A backend.app.workers.magazine.celery_app worker -Q magazine -l info -c 1
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - REDIS_URL=redis://shared-redis:6379/0
      - DATABASE_URL=postgresql+psycopg2://shared_user:shared_pass@shared_postgres:5432/mag_db
      - API_INTERNAL_URL=http://intecmar_api:8000
      - MINIO_ENDPOINT=http://shared-minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_SECURE=False
    volumes:
      - ./Intecmar_api:/app
    depends_on:
      - shared-redis
      - shared_postgres
    networks:
      - agent_network

  agent-worker:
    build: 
      context: ./Intecmar_api
    container_name: agent_worker
    command: celery -A backend.app.workers.tech_surveillance.celery_app worker -Q agent -l info
    env_file: 
      - .env
    environment:
      - PYTHONPATH=/app
      - CELERY_BROKER_URL=redis://shared-redis:6379/0
      - CELERY_RESULT_BACKEND=redis://shared-redis:6379/0
      - DATABASE_URL=postgresql+psycopg2://shared_user:shared_pass@shared_postgres:5432/mag_db
      - SHARED_DATA_PATH=/app/backend/shared_data
      - MINIO_ENDPOINT=http://shared-minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET=agent-results
    volumes:
      - ./Intecmar_api:/app
    depends_on:
      - shared-redis
      - shared-minio
      - shared_postgres
    networks:
      - agent_network

volumes:
  shared_redis_data:
  shared_postgres_data:
  shared_minio_data:

networks:
  agent_network:
    driver: bridge
